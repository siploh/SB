<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Presensi CV. Seumangat Baroe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif;}
body{background:#f4f7fa;color:#1f2937;display:flex;min-height:100vh;transition: all 0.3s;}
.sidebar{width:240px;background:#22c55e;color:#fff;flex-shrink:0;padding:30px 20px;display:flex;flex-direction:column;justify-content:space-between;border-radius:0 20px 20px 0;box-shadow:2px 0 10px rgba(0,0,0,0.1);}
.sidebar h1{font-size:22px;margin-bottom:50px;font-weight:700;}
.sidebar a{color:#fff;text-decoration:none;padding:12px 18px;border-radius:8px;margin-bottom:12px;display:block;transition:0.3s;font-weight:500;cursor:pointer;}
.sidebar a:hover{background:rgba(255,255,255,0.2);transform:translateX(5px);}
.sidebar a.active{background: rgba(255, 255, 255, 0.3); transform: translateX(5px);}
.main{flex:1;padding:35px 30px;overflow-x:auto;transition:0.3s;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
.header h2{color:#16a34a;font-size:28px;font-weight:700;}
.cards{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:30px;transition:0.3s;}
.card{flex:1 1 220px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;padding:25px 20px;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.12);transition:0.3s;}
.card:hover{transform:translateY(-5px);}
.card h3{font-size:16px;margin-bottom:12px;font-weight:500;opacity:0.9;}
.card p{font-size:24px;font-weight:700;}
.filter{display:flex;flex-wrap:wrap;gap:15px;align-items:center;margin-bottom:25px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.05);transition:0.3s;}
.filter label{flex:1 0 120px;font-weight:600;}
.filter input[type="date"],
.filter select{flex:2 0 200px;padding:10px 14px;border-radius:8px;border:1px solid #cbd5e1;transition:0.3s;}
.filter input:focus,
.filter select:focus{border-color:#22c55e;outline:none;}
.filter button{padding:10px 22px;border:none;border-radius:10px;background:#22c55e;color:#fff;font-size:15px;cursor:pointer;transition:0.3s;font-weight:600;}
.filter button:hover{background:#16a34a;transform:scale(1.05);}
#previewRekapContainer{display:none;overflow-x:auto;margin-top:20px;}
#previewRekapContainer table{min-width: max-content;border-collapse: collapse;}
#previewRekapTable th, #previewRekapTable td{padding:8px 15px;text-align:center;border:1px solid #e2e8f0;white-space: nowrap;}
#previewRekapTable th{background:#22c55e;color:#fff;font-weight:600;}
#previewRekapTable tr:nth-child(even){background:#f9fafb;}
#previewRekapTable tr:hover{background:#e6f4ea;}
#karyawanTable th, #karyawanTable td{padding:10px 12px;text-align:center;border:1px solid #e2e8f0;}
#karyawanTable th{background:#22c55e;color:#fff;font-weight:600;}
#karyawanTable tr:nth-child(even){background:#f9fafb;}
#karyawanTable tr:hover{background:#e6f4ea;}
</style>
</head>
<body>
<div class="sidebar">
    <div>
        <h1>CV. Seumangat Baroe</h1>
        <a onclick="setActive(this); showDashboard()">Dashboard</a>
        <a onclick="setActive(this); tampilkanKaryawan()">Data Karyawan</a>
    </div>
    <p style="font-size:12px;opacity:0.7;">&copy; 2026</p>
</div>

<div class="main">
    <div class="header"><h2>Presensi Karyawan</h2></div>

    <div class="cards" id="cardsSummary">
        <div class="card"><h3>Total Karyawan</h3><p id="totalKaryawan">0</p></div>
        <div class="card"><h3>Total Masuk</h3><p id="totalMasuk">0</p></div>
        <div class="card"><h3>Total Pulang</h3><p id="totalPulang">0</p></div>
    </div>

    <div class="filter" id="filterUpload">
        <label for="startDate">Tanggal Mulai:</label>
        <input type="date" id="startDate">
        <label for="endDate">Tanggal Akhir:</label>
        <input type="date" id="endDate">
        <label for="selectKaryawan">Pilih Karyawan:</label>
        <select id="selectKaryawan"><option value="all">Semua</option></select>
        <button onclick="viewRekap()">View</button>
        <button onclick="downloadExcel()">Download</button>
    </div>

    <div id="previewRekapContainer">
        <h3>Preview Rekap Presensi</h3>
        <table id="previewRekapTable"><thead></thead><tbody></tbody></table>
    </div>

    <div id="karyawanTableContainer" style="display:none;">
        <h3>Data Karyawan</h3>
        <table id="karyawanTable">
            <thead><tr><th>ID</th><th>Nama</th><th>Jenis Kelamin</th><th>Jabatan</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
// ===== DATA KARYAWAN LENGKAP =====
const karyawan = [
  {ID:"2",Nama:"EDY AMSAR",JK:"Pria",Jabatan:"ADMIN"},
  {ID:"3",Nama:"PUTRI NUR FADILA",JK:"Wanita",Jabatan:"ADMIN"},
  {ID:"4",Nama:"DWI RIZKI ANANDA",JK:"Pria",Jabatan:"ADMIN"},
  {ID:"5",Nama:"ZULKIFLI",JK:"Pria",Jabatan:"KEPALA GUDANG"},
  {ID:"6",Nama:"ULUL AMRI",JK:"Pria",Jabatan:"STAF GUDANG"},
  {ID:"7",Nama:"YURI PANGABEAN",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"8",Nama:"WAHYUDI PUTRA AMANDA",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"9",Nama:"SYAH ALI SURIOKUSUMO",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"10",Nama:"AHMAD YANI",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"11",Nama:"NURFACHRIANSYAH",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"12",Nama:"REYHAN ZANUAR IMSAN",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"13",Nama:"M. FAHMI MURAD",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"14",Nama:"FAISAL ROZA",JK:"Pria",Jabatan:"DELEVERYMAN"},
  {ID:"15",Nama:"SAIFUDIN",JK:"Pria",Jabatan:"DELEVERYMAN"},
  {ID:"16",Nama:"MUSLIM BAHRI",JK:"Pria",Jabatan:"DELEVERYMAN"},
  {ID:"17",Nama:"NURHADI",JK:"Pria",Jabatan:"HELPER"},
  {ID:"18",Nama:"AFIS FUDDINSYAH",JK:"Pria",Jabatan:"HELPER"},
  {ID:"19",Nama:"MUSLYADI",JK:"Pria",Jabatan:"HELPER"},
  {ID:"20",Nama:"MYHAMMAD KHADAFI",JK:"Pria",Jabatan:"HELPER"},
  {ID:"21",Nama:"M RIZKY PRADIKTA",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"22",Nama:"EKA WANDANI",JK:"Pria",Jabatan:"ADMIN"},
  {ID:"23",Nama:"JUNAIDI",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"25",Nama:"MARHABAN",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"28",Nama:"EDI SWONO",JK:"Pria",Jabatan:"SALESMAN"},
  {ID:"29",Nama:"RIZKY MAULANA",JK:"Pria",Jabatan:"SALESMAN"}
];

// ===== Mapping Nama =====
const namaMapping={}; 
karyawan.forEach(k=>{namaMapping[String(k.ID)]=k.Nama;});

// ===== DROPDOWN =====
const selectKaryawan = document.getElementById("selectKaryawan");
karyawan.forEach(k => {
    const option = document.createElement("option");
    option.value = k.ID;
    option.textContent = k.Nama;
    selectKaryawan.appendChild(option);
});

function setActive(element){
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    element.classList.add('active');
}
function tampilkanKaryawan(){
    document.getElementById("karyawanTableContainer").style.display="block";
    document.getElementById("cardsSummary").style.display="none";
    document.getElementById("filterUpload").style.display="none";
    document.getElementById("previewRekapContainer").style.display="none";
    const tbody=document.querySelector("#karyawanTable tbody"); tbody.innerHTML="";
    karyawan.forEach(k=>{
        const tr=document.createElement("tr");
        [k.ID,k.Nama,k.JK,k.Jabatan].forEach(val=>{const td=document.createElement("td");td.textContent=val;tr.appendChild(td);});
        tbody.appendChild(tr);
    });
}
function showDashboard(){
    document.getElementById("karyawanTableContainer").style.display="none";
    document.getElementById("cardsSummary").style.display="flex";
    document.getElementById("filterUpload").style.display="flex";
    document.getElementById("previewRekapContainer").style.display="none";
}

let filteredDataGlobal=[];

// ===== FETCH FILE DAT DARI GITHUB =====
const fileUrl = "https://siploh.github.io/Presensi/data.dat"; // ganti sesuai file .dat di repo
async function viewRekap(){
    const startDate=document.getElementById("startDate").value;
    const endDate=document.getElementById("endDate").value;
    if(!startDate || !endDate){ alert("Pilih tanggal mulai dan akhir!"); return; }

    const response = await fetch(fileUrl);
    const text = await response.text();
    const lines=text.split(/\r?\n/).filter(line=>line.trim()!=="");
    const data=lines.map(line=>{
        const cols=line.split("\t"); 
        const datetime=cols[1].split(" "); 
        const jam=datetime[1].slice(0,5);
        let status="-"; 
        const [h,m]=jam.split(":").map(Number); 
        const totalMinutes=h*60+m;
        if(totalMinutes>=7*60 && totalMinutes<=10*60) status="Masuk";
        else if(totalMinutes>=15*60 && totalMinutes<=23*60+59) status="Pulang";
        return {ID:String(cols[0]), Nama:namaMapping[String(cols[0])]||"Unknown", Tanggal:datetime[0], Jam:jam, Status:status};
    });

    const filteredData=data.filter(d=>d.Tanggal>=startDate && d.Tanggal<=endDate);
    if(!filteredData.length){alert("Tidak ada data pada rentang tanggal tersebut."); return;}

    const selectedKaryawanVal = selectKaryawan.value;
    let dataToDisplay = filteredData;
    if(selectedKaryawanVal !== "all") dataToDisplay = filteredData.filter(d => d.ID === selectedKaryawanVal);

    filteredDataGlobal = dataToDisplay;

    document.getElementById("totalKaryawan").textContent=new Set(dataToDisplay.map(r=>r.ID)).size;
    document.getElementById("totalMasuk").textContent=dataToDisplay.filter(r=>r.Status==="Masuk").length;
    document.getElementById("totalPulang").textContent=dataToDisplay.filter(r=>r.Status==="Pulang").length;

    // Render tabel preview
    const tanggalList=[]; let d=new Date(startDate), eDate=new Date(endDate);
    while(d<=eDate){ tanggalList.push(d.toISOString().slice(0,10)); d.setDate(d.getDate()+1); }

    const thead=document.querySelector("#previewRekapTable thead"); 
    const tbody=document.querySelector("#previewRekapTable tbody"); 
    thead.innerHTML=""; tbody.innerHTML="";

    const trHead=document.createElement("tr"); 
    trHead.appendChild(document.createElement("th")).textContent="NAMA KARYAWAN";
    trHead.appendChild(document.createElement("th")).textContent="BAGIAN";
    tanggalList.forEach(t=>{
        trHead.appendChild(document.createElement("th")).textContent=new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"2-digit"})+" Masuk";
        trHead.appendChild(document.createElement("th")).textContent=new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"2-digit"})+" Pulang";
    });
    thead.appendChild(trHead);

    const karyawanToRender = (selectedKaryawanVal === "all") ? karyawan : karyawan.filter(k => k.ID === selectedKaryawanVal);
    karyawanToRender.forEach(k => {
        const tr = document.createElement("tr");
        tr.appendChild(document.createElement("td")).textContent = k.Nama;
        tr.appendChild(document.createElement("td")).textContent = k.Jabatan;
        tanggalList.forEach(t => {
            const entries = dataToDisplay.filter(f => f.ID == k.ID && f.Tanggal === t);
            let jamMasuk="", jamPulang="";
            entries.forEach(e=>{if(e.Status==="Masuk") jamMasuk=e.Jam; else if(e.Status==="Pulang") jamPulang=e.Jam;});
            const dow = new Date(t).getDay();

            const tdMasuk = document.createElement("td"); tdMasuk.textContent = jamMasuk||"-";
            if(dow===0){ tdMasuk.style.backgroundColor="#3B82F6"; tdMasuk.style.color="#fff";}
            else if(!jamMasuk){ tdMasuk.style.backgroundColor="#F87171"; tdMasuk.style.color="#fff";}
            else if(jamMasuk>"08:05"){ tdMasuk.style.backgroundColor="#A855F7"; tdMasuk.style.color="#fff";} 
            tr.appendChild(tdMasuk);

            const tdPulang = document.createElement("td"); tdPulang.textContent = jamPulang||"-";
            if(dow===0){ tdPulang.style.backgroundColor="#3B82F6"; tdPulang.style.color="#fff";}
            else if(!jamPulang){ tdPulang.style.backgroundColor="#F87171"; tdPulang.style.color="#fff";}
            else if(jamPulang<"16:00"){ tdPulang.style.backgroundColor="#A855F7"; tdPulang.style.color="#fff";} 
            tr.appendChild(tdPulang);
        });
        tbody.appendChild(tr);
    });
    document.getElementById("previewRekapContainer").style.display="block";
}

// ===== DOWNLOAD EXCEL =====
function downloadExcel(){
    if(!filteredDataGlobal.length){alert("Klik View dulu!"); return;}
    const startDate=document.getElementById("startDate").value; 
    const endDate=document.getElementById("endDate").value;
    const tanggalList=[]; let d=new Date(startDate), eDate=new Date(endDate);
    while(d<=eDate){ tanggalList.push(d.toISOString().slice(0,10)); d.setDate(d.getDate()+1); }

    const ws={}; ws['A1']={v:"NAMA KARYAWAN"}; ws['B1']={v:"BAGIAN"};
    let col=2; tanggalList.forEach(t=>{
        const label=new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"2-digit"});
        ws[XLSX.utils.encode_cell({r:0,c:col})]={v:label+" Masuk"};
        ws[XLSX.utils.encode_cell({r:0,c:col+1})]={v:label+" Pulang"}; col+=2;
    });

    const selectedKaryawanVal = selectKaryawan.value;
    const karyawanToExport = (selectedKaryawanVal === "all") ? karyawan : karyawan.filter(k => k.ID === selectedKaryawanVal);

    karyawanToExport.forEach((k,i)=>{
        let r=i+1; ws[XLSX.utils.encode_cell({r,c:0})]={v:k.Nama}; ws[XLSX.utils.encode_cell({r,c:1})]={v:k.Jabatan};
        let c=2; tanggalList.forEach(t=>{
            const entries=filteredDataGlobal.filter(f=>f.ID==k.ID && f.Tanggal===t); 
            let jamMasuk="", jamPulang="";
            entries.forEach(e=>{if(e.Status==="Masuk") jamMasuk=e.Jam; else if(e.Status==="Pulang") jamPulang=e.Jam;});

            let color="FFFFFF";
            const dow=new Date(t).getDay();
            if(dow===0) color="3B82F6";
            else if(!jamMasuk) color="F87171";
            else if(jamMasuk>"08:05") color="A855F7";
            ws[XLSX.utils.encode_cell({r,c:c})]={v:jamMasuk||"-", s:{fill:{fgColor:{rgb:color}}}}; c++;

            color="FFFFFF";
            if(dow===0) color="3B82F6";
            else if(!jamPulang) color="F87171";
            else if(jamPulang<"16:00") color="A855F7";
            ws[XLSX.utils.encode_cell({r,c:c})]={v:jamPulang||"-", s:{fill:{fgColor:{rgb:color}}}}; c++;
        });
    });
    ws['!ref']=`A1:${XLSX.utils.encode_col(col-1)}${karyawanToExport.length+1}`;
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Rekap_Presensi");
    XLSX.writeFile(wb,`rekap_presensi_${startDate}_${endDate}.xlsx`);
}
</script>
</body>
</html>
